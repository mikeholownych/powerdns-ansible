# PowerDNS Recursor Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Server Role: {{ server_role | default('recursor') }}

#################################
# Basic Configuration
#################################

# Configuration directory
config-dir={{ recursor_config_dir }}

# Run as daemon
daemon=yes

# User and group
setuid={{ recursor_user | default('pdns-recursor') }}
setgid={{ recursor_group | default('pdns-recursor') }}

# Process ID file
write-pid=yes

#################################
# Network Configuration
#################################

# Local address to bind to
local-address={{ recursor_bind_address | default(ansible_default_ipv4.address) }}

# Local port
local-port={{ recursor_port | default(5353) }}

# Allow queries from these networks
allow-from={{ recursor_allowed_networks | join(',') }}

# Query local address
query-local-address={{ ansible_default_ipv4.address }}

#################################
# Forwarding Configuration
#################################

{% if recursor_forward_zones is defined %}
# Forward zones configuration
forward-zones-file={{ recursor_config_dir }}/forward-zones.conf
{% endif %}

{% if recursor_forward_zones_recurse is defined %}
# Forward zones with recursion
forward-zones-recurse={{ recursor_forward_zones_recurse | join(',') }}
{% endif %}

# Root servers hint file
hint-file={{ recursor_hint_file | default('/usr/share/dns/root.hints') }}

#################################
# Performance Tuning
#################################

# Cache settings
max-cache-entries={{ recursor_performance.max_cache_entries | default(1000000) }}
max-negative-ttl={{ recursor_performance.max_negative_ttl | default(3600) }}
max-tcp-clients={{ recursor_performance.max_tcp_clients | default(128) }}

# Threading
threads={{ recursor_performance.threads | default(2) }}
pdns-distributes-queries={{ recursor_performance.pdns_distributes_queries | default('yes') }}

# Network timeouts
network-timeout={{ recursor_performance.network_timeout | default(1500) }}
client-tcp-timeout={{ recursor_performance.client_tcp_timeout | default(2) }}
server-down-max-fails={{ recursor_performance.server_down_max_fails | default(64) }}
server-down-throttle-time={{ recursor_performance.server_down_throttle_time | default(60) }}

#################################
# Security Configuration
#################################

# Security polling
security-poll-suffix=

# Disable version disclosure
version-string=PowerDNS Recursor

# DNSSEC validation
dnssec={{ recursor_dnssec_enabled | default('validate') }}

# Spoof prevention
spoof-nearmiss-max={{ recursor_security.spoof_nearmiss_max | default(20) }}

# Rate limiting
max-qperq={{ recursor_security.max_qperq | default(60) }}
max-total-msec={{ recursor_security.max_total_msec | default(7000) }}

#################################
# Logging Configuration
#################################

# Log level (0-9, higher is more verbose)
loglevel={{ recursor_logging.level | default(4) }}

# Logging facility
logging-facility={{ recursor_logging.facility | default(0) }}

# Quiet mode
quiet={{ recursor_logging.quiet | default('no') }}

# Log common errors
log-common-errors={{ recursor_logging.log_common_errors | default('yes') }}

#################################
# API Configuration
#################################

{% if recursor_api_enabled | default(false) %}
# Enable API
webserver=yes
webserver-address={{ recursor_api_bind_address | default(ansible_default_ipv4.address) }}
webserver-port={{ recursor_api_port | default(8082) }}
webserver-allow-from={{ recursor_api_allowed_networks | join(',') }}

# API key
api-key={{ recursor_api_key }}

# API readonly mode
webserver-readonly={{ recursor_api_readonly | default('yes') }}
{% else %}
# API disabled
webserver=no
{% endif %}

#################################
# Advanced Settings
#################################

# Lua configuration
{% if recursor_lua_config_enabled | default(false) %}
lua-config-file={{ recursor_config_dir }}/recursor.lua
{% endif %}

# Export /etc/hosts
export-etc-hosts={{ recursor_export_etc_hosts | default('yes') }}

# Serve RFC1918 names
serve-rfc1918={{ recursor_serve_rfc1918 | default('yes') }}

# Local data
{% if recursor_local_data is defined %}
{% for record in recursor_local_data %}
local-data={{ record }}
{% endfor %}
{% endif %}

# Statistics
stats-ringbuffer-entries={{ recursor_stats.ringbuffer_entries | default(10000) }}

#################################
# Monitoring and Health Checks
#################################

{% if recursor_monitoring_enabled | default(true) %}
# Carbon server (for Graphite/Prometheus)
# carbon-server=127.0.0.1
# carbon-interval=30
{% endif %}

#################################
# Split-Horizon DNS
#################################

{% if recursor_split_horizon_enabled | default(false) %}
# Split horizon configuration
{% for zone, servers in recursor_split_horizon_zones.items() %}
forward-zones+={{ zone }}={{ servers | join(';') }}
{% endfor %}
{% endif %}

#################################
# Integration with Authoritative
#################################

{% if recursor_auth_integration_enabled | default(true) %}
# Forward local zones to authoritative servers
{% for domain in primary_domains | default([]) %}
forward-zones+={{ domain }}={{ groups['powerdns_primary'] | map('extract', hostvars, 'ansible_default_ipv4') | map(attribute='address') | join(';') }}
{% endfor %}

{% for domain in ad_domains | default([]) %}
forward-zones+={{ domain }}={{ ad_primary_ip | default('192.168.1.104') }};{{ ad_secondary_ip | default('192.168.1.123') }}
{% endfor %}
{% endif %}

#################################
# Custom Configuration
#################################

{% if recursor_custom_config is defined %}
# Custom configuration entries
{% for key, value in recursor_custom_config.items() %}
{{ key }}={{ value }}
{% endfor %}
{% endif %}

# End of configuration
