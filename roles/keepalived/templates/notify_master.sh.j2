#!/bin/bash
# Keepalived Master Notification Script
# Generated by Ansible

SERVICE_TYPE="${1:-MAIN}"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
HOSTNAME=$(hostname)
LOG_FILE="/var/log/keepalived-notify.log"

# Logging function
log_message() {
    echo "[$TIMESTAMP] MASTER ($SERVICE_TYPE): $1" | tee -a "$LOG_FILE"
}

log_message "Transitioning to MASTER state on $HOSTNAME"

case "$SERVICE_TYPE" in
    "DNS")
        log_message "Configuring DNS service as primary"
        # Ensure PowerDNS is running and configured as master
        systemctl start {{ powerdns_service_name }}
        # Update DNS records if needed
        ;;
    "MYSQL")
        log_message "Configuring MySQL service as primary"
        # Disable read-only mode
        mysql -u root -p{{ mysql_root_password | default('') }} -e "SET GLOBAL read_only = OFF;" 2>/dev/null || true
        ;;
    *)
        log_message "General MASTER transition"
        # Ensure all services are running
        systemctl start {{ powerdns_service_name }}
        systemctl start {{ mysql_service_name }}
        ;;
esac

# Send notification email if configured
{% if alert_email is defined %}
if command -v mail >/dev/null 2>&1; then
    echo "Server $HOSTNAME has become MASTER for $SERVICE_TYPE at $TIMESTAMP" | \
    mail -s "Keepalived MASTER Transition - $HOSTNAME" {{ alert_email }}
fi
{% endif %}

# Custom notification webhook if configured
{% if keepalived_webhook_url is defined %}
if command -v curl >/dev/null 2>&1; then
    curl -X POST "{{ keepalived_webhook_url }}" \
         -H "Content-Type: application/json" \
         -d "{\"event\":\"master_transition\",\"hostname\":\"$HOSTNAME\",\"service\":\"$SERVICE_TYPE\",\"timestamp\":\"$TIMESTAMP\"}" \
         >/dev/null 2>&1 || true
fi
{% endif %}

log_message "MASTER transition completed successfully"
exit 0
