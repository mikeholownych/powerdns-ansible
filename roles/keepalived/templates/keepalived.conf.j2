# Keepalived Configuration for PowerDNS High Availability
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Server: {{ inventory_hostname }} ({{ server_role }})

global_defs {
    router_id {{ inventory_hostname }}
    vrrp_version 3
    vrrp_garp_interval 0
    vrrp_gna_interval 0
    script_user root
    enable_script_security
}

# Health check scripts
vrrp_script chk_powerdns {
    script "/etc/keepalived/scripts/check_powerdns.sh"
    interval {{ keepalived_check_interval | default(5) }}
    weight {{ keepalived_powerdns_weight | default(-10) }}
    fall {{ keepalived_check_fall | default(2) }}
    rise {{ keepalived_check_rise | default(2) }}
}

vrrp_script chk_mysql {
    script "/etc/keepalived/scripts/check_mysql.sh"
    interval {{ keepalived_check_interval | default(5) }}
    weight {{ keepalived_mysql_weight | default(-5) }}
    fall {{ keepalived_check_fall | default(2) }}
    rise {{ keepalived_check_rise | default(2) }}
}

{% if keepalived_haproxy_enabled | default(false) %}
vrrp_script chk_haproxy {
    script "/etc/keepalived/scripts/check_haproxy.sh"
    interval {{ keepalived_check_interval | default(5) }}
    weight {{ keepalived_haproxy_weight | default(-15) }}
    fall {{ keepalived_check_fall | default(2) }}
    rise {{ keepalived_check_rise | default(2) }}
}
{% endif %}

# VRRP instance for PowerDNS
vrrp_instance VI_POWERDNS {
    state {{ 'MASTER' if server_role == 'primary' else 'BACKUP' }}
    interface {{ keepalived_interface | default(ansible_default_ipv4.interface) }}
    virtual_router_id {{ keepalived_router_id | default(51) }}
    priority {{ keepalived_priority[server_role] | default(100) }}
    advert_int {{ keepalived_advert_int | default(1) }}
    
    authentication {
        auth_type PASS
        auth_pass {{ keepalived_auth_pass }}
    }
    
    virtual_ipaddress {
        {{ keepalived_vip }}/{{ keepalived_vip_netmask | default(24) }} dev {{ keepalived_interface | default(ansible_default_ipv4.interface) }}
    }
    
    track_script {
        chk_powerdns
        chk_mysql
{% if keepalived_haproxy_enabled | default(false) %}
        chk_haproxy
{% endif %}
    }
    
    notify_master "/etc/keepalived/scripts/notify_master.sh"
    notify_backup "/etc/keepalived/scripts/notify_backup.sh"
    notify_fault "/etc/keepalived/scripts/notify_fault.sh"
    
    # Preemption settings
    preempt_delay {{ keepalived_preempt_delay | default(60) }}
    {% if server_role != 'primary' %}
    nopreempt
    {% endif %}
}

{% if keepalived_dns_vip_enabled | default(true) %}
# VRRP instance for DNS service
vrrp_instance VI_DNS {
    state {{ 'MASTER' if server_role == 'primary' else 'BACKUP' }}
    interface {{ keepalived_interface | default(ansible_default_ipv4.interface) }}
    virtual_router_id {{ keepalived_dns_router_id | default(52) }}
    priority {{ keepalived_dns_priority[server_role] | default(90) }}
    advert_int {{ keepalived_advert_int | default(1) }}
    
    authentication {
        auth_type PASS
        auth_pass {{ keepalived_auth_pass }}
    }
    
    virtual_ipaddress {
        {{ keepalived_dns_vip }}/{{ keepalived_vip_netmask | default(24) }} dev {{ keepalived_interface | default(ansible_default_ipv4.interface) }}
    }
    
    track_script {
        chk_powerdns
    }
    
    notify_master "/etc/keepalived/scripts/notify_master.sh DNS"
    notify_backup "/etc/keepalived/scripts/notify_backup.sh DNS"
    notify_fault "/etc/keepalived/scripts/notify_fault.sh DNS"
}
{% endif %}

{% if keepalived_mysql_vip_enabled | default(false) %}
# VRRP instance for MySQL service
vrrp_instance VI_MYSQL {
    state {{ 'MASTER' if server_role == 'primary' else 'BACKUP' }}
    interface {{ keepalived_interface | default(ansible_default_ipv4.interface) }}
    virtual_router_id {{ keepalived_mysql_router_id | default(53) }}
    priority {{ keepalived_mysql_priority[server_role] | default(80) }}
    advert_int {{ keepalived_advert_int | default(1) }}
    
    authentication {
        auth_type PASS
        auth_pass {{ keepalived_auth_pass }}
    }
    
    virtual_ipaddress {
        {{ keepalived_mysql_vip }}/{{ keepalived_vip_netmask | default(24) }} dev {{ keepalived_interface | default(ansible_default_ipv4.interface) }}
    }
    
    track_script {
        chk_mysql
    }
    
    notify_master "/etc/keepalived/scripts/notify_master.sh MYSQL"
    notify_backup "/etc/keepalived/scripts/notify_backup.sh MYSQL"
    notify_fault "/etc/keepalived/scripts/notify_fault.sh MYSQL"
}
{% endif %}

{% if keepalived_custom_instances is defined %}
# Custom VRRP instances
{% for instance in keepalived_custom_instances %}
vrrp_instance {{ instance.name }} {
    state {{ instance.state | default('BACKUP') }}
    interface {{ instance.interface | default(ansible_default_ipv4.interface) }}
    virtual_router_id {{ instance.router_id }}
    priority {{ instance.priority | default(100) }}
    advert_int {{ instance.advert_int | default(1) }}
    
    authentication {
        auth_type PASS
        auth_pass {{ instance.auth_pass | default(keepalived_auth_pass) }}
    }
    
    virtual_ipaddress {
        {{ instance.vip }}/{{ instance.netmask | default(24) }} dev {{ instance.interface | default(ansible_default_ipv4.interface) }}
    }
    
    {% if instance.track_scripts is defined %}
    track_script {
        {% for script in instance.track_scripts %}
        {{ script }}
        {% endfor %}
    }
    {% endif %}
    
    {% if instance.notify_scripts is defined %}
    notify_master "{{ instance.notify_scripts.master | default('/etc/keepalived/scripts/notify_master.sh') }}"
    notify_backup "{{ instance.notify_scripts.backup | default('/etc/keepalived/scripts/notify_backup.sh') }}"
    notify_fault "{{ instance.notify_scripts.fault | default('/etc/keepalived/scripts/notify_fault.sh') }}"
    {% endif %}
}
{% endfor %}
{% endif %}
