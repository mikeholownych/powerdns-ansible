#!/bin/bash
# MySQL Health Check Script for Keepalived
# Generated by Ansible

# Exit codes:
# 0 - Service is healthy
# 1 - Service is unhealthy

# Check if MySQL service is running
if ! systemctl is-active --quiet {{ mysql_service_name }}; then
    exit 1
fi

# Check if MySQL is accepting connections
if ! mysql -u {{ mysql_monitor_user | default('mysql_monitor') }} -p{{ mysql_monitor_password | default('monitor123') }} -e "SELECT 1;" >/dev/null 2>&1; then
    exit 1
fi

# Check PowerDNS database accessibility
if ! mysql -u {{ powerdns_db_user }} -p{{ powerdns_db_password }} -h {{ powerdns_db_host }} -D {{ powerdns_db_name }} -e "SELECT COUNT(*) FROM domains;" >/dev/null 2>&1; then
    exit 1
fi

# All checks passed
exit 0
