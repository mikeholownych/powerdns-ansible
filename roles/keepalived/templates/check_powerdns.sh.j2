#!/bin/bash
# PowerDNS Health Check Script for Keepalived
# Generated by Ansible

# Exit codes:
# 0 - Service is healthy
# 1 - Service is unhealthy

# Check if PowerDNS service is running
if ! systemctl is-active --quiet {{ powerdns_service_name }}; then
    exit 1
fi

# Check if PowerDNS is responding to DNS queries
if ! dig @{{ ansible_default_ipv4.address }} +time=2 +tries=1 localhost >/dev/null 2>&1; then
    exit 1
fi

# Check if PowerDNS API is responding (if enabled)
{% if powerdns_api_readonly is defined %}
if ! curl -s -f -m 5 "http://{{ ansible_default_ipv4.address }}:{{ powerdns_webserver_port | default(8081) }}/api/v1/servers" >/dev/null 2>&1; then
    exit 1
fi
{% endif %}

# All checks passed
exit 0
