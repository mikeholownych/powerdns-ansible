# PowerDNS Configuration - Generated by Ansible
# Server Role: {{ server_role }}
# Generated on: {{ ansible_date_time.iso8601 }}

#################################
# Basic Configuration
#################################

# Configuration directory
config-dir={{ powerdns_config_dir }}

# Run as daemon
daemon=yes
guardian=yes

# User and group
setuid={{ powerdns_user }}
setgid={{ powerdns_group }}

# Process ID file
write-pid=yes

#################################
# Network Configuration
#################################

# Local address to bind to
local-address={{ ansible_default_ipv4.address }}

# Local port
local-port=53

# Allow recursion from these networks

# Query local address
query-local-address={{ ansible_default_ipv4.address }}

#################################
# Database Backend
#################################

# Launch backend
launch={{ powerdns_backend }}

# MySQL backend configuration
gmysql-host={{ powerdns_db_host }}
gmysql-port={{ powerdns_db_port }}
gmysql-dbname={{ powerdns_db_name }}
gmysql-user={{ powerdns_db_user }}
gmysql-password={{ powerdns_db_password }}

# Database connection settings
gmysql-dnssec=yes
gmysql-timeout=10

#################################
# Performance Tuning
#################################

# Cache settings
cache-ttl={{ performance_config.cache_ttl }}
negquery-cache-ttl={{ performance_config.negquery_cache_ttl }}
query-cache-ttl={{ performance_config.query_cache_ttl }}
recursive-cache-ttl={{ performance_config.recursive_cache_ttl }}

# Threading
distributor-threads={{ performance_config.distributor_threads }}
receiver-threads={{ performance_config.receiver_threads }}

# Connection limits
max-tcp-connections={{ performance_config.max_tcp_connections }}
max-queue-length={{ performance_config.max_queue_length }}

# TCP settings
tcp-control-address=127.0.0.1
tcp-control-port=53000

#################################
# Logging Configuration
#################################

# Log level (0=emergency, 1=alert, 2=critical, 3=error, 4=warning, 5=notice, 6=info, 7=debug)
loglevel={{ logging_config.level }}

# Detailed logging
log-dns-details={{ logging_config.dns_details | lower }}
log-dns-queries={{ logging_config.dns_queries | lower }}

# Logging facility
logging-facility={{ logging_config.facility }}

#################################
# Security Configuration
#################################

# Disable version disclosure
version-string=PowerDNS

# Security polling
security-poll-suffix=

#################################
# API Configuration
#################################

{% if powerdns_api_readonly is defined %}
# Enable API
api=yes
api-key={{ powerdns_api_key }}

# Web server settings
webserver=yes
webserver-address={{ ansible_default_ipv4.address }}
webserver-port={{ powerdns_webserver_port | default(8081) }}
webserver-allow-from={{ powerdns_webserver_allow_from | join(',') }}

# API readonly mode
api-readonly={{ powerdns_api_readonly | lower }}
{% else %}
# API disabled
api=no
webserver=no
{% endif %}

#################################
# Role-Specific Configuration
#################################

{% if server_role == 'primary' %}
#################################
# PRIMARY Server Configuration
#################################

# Master mode
master=yes
slave=no

# Zone transfers
allow-axfr-ips={{ allow_axfr_ips | default('127.0.0.1') }}

# Notifications
also-notify={{ slave_notification_ips | default('') }}

# SOA settings
default-soa-name={{ zone_templates.primary.soa_name | default('ns1.' + primary_domains[0]) }}
default-soa-mail={{ zone_templates.primary.soa_mail | default('admin.' + primary_domains[0]) }}
default-ttl=3600

# DNSSEC
dnssec=yes
default-ksk-algorithm=ecdsa256
default-zsk-algorithm=ecdsa256

{% else %}
#################################
# SECONDARY Server Configuration
#################################

# Slave mode
master=no
slave=yes

# Slave settings
slave-cycle-interval=60
slave-renotify=yes

# Supermaster settings
supermasters=yes

{% endif %}

#################################
# Zone Configuration
#################################

# Include additional configuration files
include-dir={{ powerdns_config_dir }}/conf.d

#################################
# Monitoring and Statistics
#################################

{% if monitoring_config.enabled | default(true) %}
# Carbon server (for Graphite/Prometheus)
# carbon-server=127.0.0.1
# carbon-interval=30

# Statistics
webserver-print-arguments=yes
{% endif %}

#################################
# Advanced Settings
#################################

# Packet cache
packet-cache-ttl=20
packet-cache-size=1048576

# Signature cache
signature-cache-size=1048576

# Query logging (disable in production for performance)
{% if development_mode | default(false) %}
query-logging=yes
{% else %}
query-logging=no
{% endif %}

# Lua scripts directory
lua-prequery-script={{ powerdns_config_dir }}/prequery.lua
lua-dnsupdate-policy-script={{ powerdns_config_dir }}/dnsupdate.lua

# End of configuration
