# Fail2ban configuration for PowerDNS
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

[DEFAULT]
# Ban hosts for one hour:
bantime = 3600

# Override /etc/fail2ban/jail.conf defaults
bantime = 3600
findtime = 600
maxretry = 3

# "ignoreip" can be an IP address, a CIDR mask or a DNS host. Fail2ban will not
# ban a host which matches an address in this list. Several addresses can be
# defined using space separator.
ignoreip = 127.0.0.1/8 {{ dns_network }}

# Email settings
destemail = {{ alert_email | default('root@localhost') }}
sender = fail2ban@{{ ansible_fqdn }}
mta = sendmail
action = %(action_mwl)s

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

[powerdns]
enabled = true
port = 53
protocol = udp
filter = powerdns
logpath = /var/log/powerdns/*.log
maxretry = 10
findtime = 300
bantime = 1800

[powerdns-api]
enabled = {{ 'true' if powerdns_webserver_port is defined else 'false' }}
{% if powerdns_webserver_port is defined %}
port = {{ powerdns_webserver_port }}
protocol = tcp
filter = powerdns-api
logpath = /var/log/powerdns/*.log
maxretry = 5
findtime = 300
bantime = 3600
{% endif %}

[mysql]
enabled = true
port = 3306
filter = mysql
logpath = /var/log/mysql/error.log
maxretry = 5
bantime = 3600

[recidive]
enabled = true
filter = recidive
logpath = /var/log/fail2ban.log
action = %(action_mwl)s
bantime = 604800  ; 1 week
findtime = 86400   ; 1 day
maxretry = 5

# Custom jail for repeated DNS abuse
[dns-abuse]
enabled = true
port = 53
protocol = udp
filter = dns-abuse
logpath = /var/log/powerdns/*.log
maxretry = 50
findtime = 60
bantime = 7200
